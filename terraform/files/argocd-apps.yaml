resources:
  - apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: applications
      namespace: argocd
      # Finalizer that ensures that project is not deleted until it is not referenced by any application
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      # Project description
      description: Application Project
      
      # Allow manifests to deploy from any Git repos
      sourceRepos:
        - '*'
      
      # Only permit applications to deploy to the guestbook namespace in the same cluster
      # Destination clusters can be identified by 'server', 'name', or both.
      destinations:
        - namespace: '*'
          server: https://kubernetes.default.svc
          name: in-cluster
      
      # Deny all cluster-scoped resources from being created, except for Namespace
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      
      # Allow all namespaced-scoped resources to be created, except for ResourceQuota, LimitRange, NetworkPolicy
      namespaceResourceBlacklist:
        - group: ''
          kind: ResourceQuota
        - group: ''
          kind: LimitRange
        - group: ''
          kind: NetworkPolicy
      
      # Deny all namespaced-scoped resources from being created, except for Deployment and StatefulSet
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
      
      # Enables namespace orphaned resource monitoring.
      orphanedResources:
        warn: false
      
      roles: [ ]
      
      # Sync windows restrict when Applications may be synced. https://argo-cd.readthedocs.io/en/stable/user-guide/sync_windows/
      syncWindows: []
#        - kind: allow
#          schedule: '10 1 * * *'
#          duration: 1h
#          applications:
#            - '*-prod'
#          manualSync: true
#        - kind: deny
#          schedule: '0 22 * * *'
#          duration: 1h
#          namespaces:
#            - default
      
      # By default, apps may sync to any cluster specified under the `destinations` field, even if they are not
      # scoped to this project. Set the following field to `true` to restrict apps in this cluster to only clusters
      # scoped to this project.
      permitOnlyProjectScopedClusters: false
      
      # When using Applications-in-any-namespace, this field determines which namespaces this AppProject permits
      # Applications to reside in. Details: https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/
      sourceNamespaces:
        - "argocd-apps-*"
        - "argocd"

  - apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: wazuh-eksa-${environment}
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: applications
      source:
        repoURL: https://chartmuseum.wazuh.adorsys.team
        targetRevision: ${target_revision}
        chart: wazuh-helm
        helm:
          repoUsername: ${wazuh_api_username}
          repoPassword: ${wazuh_api_password}
      destination:
        server: https://kubernetes.default.svc
        namespace: wazuh
      syncPolicy:
        automated:
          prune: true
          selfHeal: true

  - apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: wazuh-secrets-${environment}
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: infrastructure
      source:
        repoURL: https://github.com/ADORSYS-GIS/wazuh-eksa
        targetRevision: ${target_revision}
        path: apps/eksa-dev
      destination:
        server: https://kubernetes.default.svc
        namespace: wazuh
      syncPolicy:
        automated:
          prune: true
          selfHeal: true